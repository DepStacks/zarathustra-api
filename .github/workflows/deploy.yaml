name: Deploy Zarathustra API

on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  validate:
    name: Validate and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pydantic boto3
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Install AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          version: "1.142.1"

      - name: Validate SAM template
        run: sam validate --lint

      - name: Build SAM application
        run: sam build

      - name: Run basic validation tests
        run: |
          echo "Running basic validation tests..."
          python -c "
          import sys
          sys.path.append('.')
          try:
              from models.schemas import PromptRequest, SqsMessage, ApiResponse, ErrorResponse
              print('‚úì Data models validation passed')
              
              import handlers.prompt_handler
              import handlers.health_handler
              print('‚úì Handler modules validation passed')
              
              print('üéâ All validation tests passed!')
          except Exception as e:
              print(f'‚ùå Validation failed: {e}')
              sys.exit(1)
          "

  deploy:
    name: Deploy to AWS
    runs-on: ubuntu-latest
    needs: validate
    if: github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch'
    env:
      AWS_REGION: ${{ vars.AWS_REGION || 'us-east-1' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          version: "1.142.1"

      - name: Build SAM application
        run: sam build

      - name: Deploy to AWS
        run: |
          sam deploy --config-env default \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --region ${{ env.AWS_REGION }} \
            --parameter-overrides \
              ApiKeyName="zarathustra-api-key"

      - name: Get deployment outputs
        run: |
          echo "Getting deployment outputs..."
          
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name zarathustra-api \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ZarathustraApiUrl`].OutputValue' \
            --output text)
          
          API_KEY_ID=$(aws cloudformation describe-stacks \
            --stack-name zarathustra-api \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`ZarathustraApiKeyId`].OutputValue' \
            --output text)
          
          QUEUE_URL=$(aws cloudformation describe-stacks \
            --stack-name zarathustra-api \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`AgentRequestQueueUrl`].OutputValue' \
            --output text)
          
          echo "üéâ Deployment successful!"
          echo "üìç API URL: $API_URL"
          echo "üîë API Key ID: $API_KEY_ID"
          echo "üì¨ SQS Queue: $QUEUE_URL"
          echo "üåç Region: ${{ env.AWS_REGION }}"

      - name: Test health endpoint
        run: |
          API_URL=$(aws cloudformation describe-stacks \
            --stack-name zarathustra-api \
            --region ${{ env.AWS_REGION }} \
            --query 'Stacks[0].Outputs[?OutputKey==`HealthEndpoint`].OutputValue' \
            --output text)
          
          echo "Testing health endpoint: $API_URL"
          curl -s "$API_URL" | jq .
